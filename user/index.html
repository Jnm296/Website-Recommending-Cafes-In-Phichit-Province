<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผู้ใช้งาน</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<body>
    <nav>
        <div class="logo">เว็บไซต์แนะนำคาเฟ่ในจังหวัดพิจิตร</div>
        <ul class="nav-links">
            <li><a href="../index.html">หน้าแรก</a></li>
            <li><a href="../allcafe/index.html">รวมคาเฟ่</a></li>
            <li><a href="../map/index.html">แนะนำทริป</a></li>
            <li><a href="../reviews/index.html">รีวิว</a></li>
            <li><a href="../contact/index.html">ติดต่อเรา</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="profile-grid">
            
    <aside class="profile-sidebar">
    <div class="user-avatar" id="user-avatar-container">
        <img id="user-photo" src="../imagas/coffee-beans.png" alt="โปรไฟล์" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
    </div>
    
    <h2 id="user-name-display">กำลังโหลด...</h2>
    <p id="user-email">user.cafe@example.com</p>
    
    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
    
    <a href="javascript:void(0)" class="logout-btn" id="logout-btn">ออกจากระบบ (Logout)</a>
</aside>

            <main class="profile-main">
                
                <section class="card">

    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
    <h3 style="margin: 0;">คาเฟ่ที่ฉันชอบ</h3>
    <a href="my-favorites.html" style="font-size: 0.8rem; color: #4a5d4d; text-decoration: none; display: flex; align-items: center; gap: 5px;">
        ดูเพิ่มเติม <i class="fas fa-chevron-right"></i>
    </a>
</div>

<div id="favoriteList">
    </div>
    <div class="list-items" id="favorite-list">
        <p>กำลังโหลดรายการโปรด...</p>
    </div>
</section>

  

        <section class="card" style="margin-top: 30px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h3 style="margin: 0;">รีวิวล่าสุดของฉัน</h3>
        <a href="my-reviews.html" style="font-size: 0.8rem; color: #4a5d4d; text-decoration: none; display: flex; align-items: center; gap: 5px;">
            ดูเพิ่มเติม <i class="fas fa-chevron-right"></i>
        </a>
    </div>
    
    <div class="list-items horizontal-review-list" id="latest-reviews-container">
        <p>กำลังโหลดรีวิว...</p>
    </div>
</section>

                

            </main>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDt4kR8SacD2LPwmyFpcZ4FNHJpCT-pOwc",
        authDomain: "phichit-cafe.firebaseapp.com",
        projectId: "phichit-cafe",
        storageBucket: "phichit-cafe.firebasestorage.app",
        messagingSenderId: "825175930096",
        appId: "1:825175930096:web:32336ea0ebc1cdf3c33e35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ฟังก์ชันแสดงรีวิว (จำกัด 3 อัน แนวนอนยาว รูปท้าย) ---
    function displayReviewCards(snapshot, container) {
        let content = "";
        let count = 0;

        snapshot.forEach(doc => {
            if (count < 3) {
                const data = doc.data();
                // จับคู่ชื่อร้านกับชื่อไฟล์ cafe00x
                const cafeMap = {
                    "14:25 Hours.": "cafe001",
                    "Bonnie Cafe & Bakery": "cafe002",
                    "Chim Niyom Cafe": "cafe003",
                    "Faamsuk cafe": "cafe004" 
                };
                const fileName = cafeMap[data.name] || "allcafe/index"; 

                content += `
                    <a href="../cafe/${fileName}.html" class="review-item-long" style="text-decoration: none; color: inherit; display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px 15px; margin-bottom: 10px;">
                        <div class="review-info" style="flex: 1;">
                            <h4 style="margin: 0; font-size: 1rem; color: #4a5d4d;">${data.name}</h4>
                            <p style="margin: 5px 0 0; font-size: 0.85rem; color: #666; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">${data.reviewText}</p>
                        </div>
                        <div class="review-img-end" style="width: 50px; height: 50px; margin-left: 15px;">
                            <img src="${data.imageURL || '../imagas/coffee-beans.png'}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        </div>
                    </a>`;
                count++;
            }
        });
        container.innerHTML = content || `<p style="color: #888; font-size: 0.9rem; padding: 10px;">ยังไม่มีประวัติการรีวิว</p>`;
    }

    // --- ฟังก์ชันหลักเมื่อ Login ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "../index.html";
            return;
        }

        const nameDisplay = document.getElementById('user-name-display');
        const emailDisplay = document.getElementById('user-email');
        const userPhoto = document.getElementById('user-photo'); 
        const favoriteList = document.getElementById('favorite-list');
        const reviewContainer = document.getElementById("latest-reviews-container");

        // 1. แสดงข้อมูลผู้ใช้พื้นฐาน
        if (emailDisplay) emailDisplay.innerText = user.email;
        if (userPhoto && user.photoURL) userPhoto.src = user.photoURL;

        try {
            // 2. ดึงข้อมูล Profile จาก Firestore
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                if (nameDisplay && userData.name) nameDisplay.innerText = userData.name;
                if (userData.photo && userPhoto) userPhoto.src = userData.photo;
            } else {
                if (nameDisplay) nameDisplay.innerText = user.displayName || "ผู้ใช้งาน";
            }

            // 3. ดึงคาเฟ่ที่ชอบ (จำกัด 3 อัน)
            if (favoriteList) {
                const favRef = collection(db, "users", user.uid, "favorites");
                const favSnapshot = await getDocs(favRef);
                favoriteList.innerHTML = ''; 

                if (favSnapshot.empty) {
                    favoriteList.innerHTML = '<p style="color: #888; font-size: 0.9rem; padding: 10px;">คุณยังไม่มีคาเฟ่ที่ถูกใจ</p>';
                } else {
                    let favCount = 0;
                    favSnapshot.forEach((doc) => {
                        if (favCount < 3) {
                            const cafe = doc.data();
                            favoriteList.innerHTML += `
                                <a href="../cafe/${doc.id}.html" class="item" style="text-decoration: none; color: inherit; display: block;">
                                    <img src="..${cafe.image}" alt="${cafe.name}">
                                    <span>${cafe.name}</span>
                                </a>`;
                            favCount++;
                        }
                    });
                }
            }

            // 4. ดึงรีวิวล่าสุด (จำกัด 3 อัน)
            // 4. ดึงรีวิวล่าสุด (จำกัด 3 อัน เฉพาะของตัวเอง)
const q = query(
    collection(db, "cafes"), 
    where("userId", "==", user.uid), // <--- เพิ่มบรรทัดนี้เพื่อกรองเอาเฉพาะของเรา
    orderBy("timestamp", "desc"), 
    limit(3)
);
const reviewSnapshot = await getDocs(q);
displayReviewCards(reviewSnapshot, reviewContainer);

          
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    });

    // --- ออกจากระบบ ---
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
                auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.href = "../index.html";
                });
            }
        });
    }
</script>