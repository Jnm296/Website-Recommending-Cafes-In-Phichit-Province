<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าแรก - Cafe Phichit</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="floating-auth">
        <div id="userAvatar" class="user-profile-float" onclick="location.href='user/index.html'">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mimi" alt="Avatar">
        </div>
    </div>

    <div id="loginModal" class="login-full-page">
        <div class="login-box">
            <h2>Welcome Back!</h2>
            <p style="color:#888; font-size: 0.9rem; margin-top:-20px; margin-bottom: 25px;">ล็อกอินเพื่อบันทึกคาเฟ่โปรดของคุณ</p>
            
            <form onsubmit="handleLogin(event)">
                <input type="email" placeholder="อีเมลของคุณ" required>
                <input type="password" placeholder="รหัสผ่าน" required>
                <button type="submit" class="btn-login-submit">เข้าสู่ระบบ</button>
            </form>

            <div style="margin: 20px 0; color: #ddd; font-size: 0.8rem;">หรือเชื่อมต่อด้วย</div>

            <div class="social-login-mini">
                <div id="googleBtn" style="display: flex; justify-content: center; margin-top: 10px;"></div>
            </div>

            <div style="margin-top: 25px; text-align: center; font-size: 14px; color: #666;">
                <span>ยังไม่มีบัญชีใช่ไหม?</span>
                <a href="register.html" style="color: #4A6741; font-weight: bold; text-decoration: none; margin-left: 5px;">สมัครสมาชิกเลย</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDt4kR8SacD2LPwmyFpcZ4FNHJpCT-pOwc",
            authDomain: "phichit-cafe.firebaseapp.com",
            databaseURL: "https://phichit-cafe-default-rtdb.firebaseio.com",
            projectId: "phichit-cafe",
            storageBucket: "phichit-cafe.firebasestorage.app",
            messagingSenderId: "825175930096",
            appId: "1:825175930096:web:32336ea0ebc1cdf3c33e35",
            measurementId: "G-SNG4GZ50C0" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function getCafes() {
            const querySnapshot = await getDocs(collection(db, "cafes"));
        }
        getCafes();

        // ฟังก์ชัน Login ด้วย Email/Password ปกติ
        function handleLogin(e) {
            e.preventDefault();
            // เมื่อ Login สำเร็จ ให้ซ่อนหน้า Login และโชว์หน้าเนื้อหา (หรือไปหน้าอื่น)
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('userAvatar').style.display = 'block';
            alert('ยินดีต้อนรับ! ล็อกอินสำเร็จแล้วค่ะ');
            // location.href = 'home.html'; // หากต้องการให้เปลี่ยนหน้าไปเลย
        }

        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "33280567312-hrdbjnk3g9guqsfe21coqn0mfpv3n6np.apps.googleusercontent.com",
                callback: handleGoogleResponse
            });
            
            google.accounts.id.renderButton(
                document.getElementById("googleBtn"),
                { theme: "outline", size: "large", width: "240" }
            );
        }

        async function handleGoogleResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);

            localStorage.setItem('userProfile', JSON.stringify({
                name: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture
            }));

            try {
                await setDoc(doc(db, "users", responsePayload.sub), {
                    name: responsePayload.name,
                    email: responsePayload.email,
                    photo: responsePayload.picture,
                    lastLogin: new Date()
                }, { merge: true });
                console.log("บันทึกข้อมูลลง Firestore สำเร็จ!");
            } catch (e) {
                console.error("เกิดข้อผิดพลาด: ", e);
            }

            document.getElementById('loginModal').style.display = 'none';
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.style.display = 'block';
            userAvatar.querySelector('img').src = responsePayload.picture;

            alert('ยินดีต้อนรับคุณ ' + responsePayload.name + ' เข้าสู่เว็บไซต์แนะนำคาเฟ่ในพิจิตรค่ะ!');
        }

        function decodeJwtResponse(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        window.handleGoogleResponse = handleGoogleResponse;
        window.handleLogin = handleLogin;
    </script>
</body>