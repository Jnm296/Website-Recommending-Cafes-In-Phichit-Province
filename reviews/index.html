<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="https://www.phichit.go.th/phichit/" class="logo-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px;">
            <div class="logo-container">
                <div class="logo-circle">
                    <img src="../imagas/images.jpg" alt="Logo">
                </div>
            </div>
        </a>
        <ul class="nav-links">
            <li><a href="../index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
            <li><a href="../allcafe/index.html">‡∏£‡∏ß‡∏°‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</a></li>
            <li><a href="../reviews/index.html">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</a></li>
            <li><a href="../contact/index.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a></li>
        </ul>
    </nav>

    <header class="page-header">
        <h1>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h1>
        <p>‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï‡πÉ‡∏ô‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£</p>

        <div class="search-box" style="position: relative; display: flex; justify-content: center; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£..." 
                       style="padding: 12px 25px; width: 350px; border-radius: 30px; border: 1px solid #ddd; font-family: 'Kanit'; outline: none;">
                <ul id="suggestionList" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); list-style: none; padding: 10px 0; margin: 5px 0; z-index: 2000; text-align: left; max-height: 375px; overflow-y: auto;"></ul>
            </div>

            <button id="searchButton" style="padding: 12px 30px; border-radius: 30px; background-color: #4a5d4d; color: white; border: none; cursor: pointer; font-family: 'Kanit'; white-space: nowrap;">
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
        </div>  
    </header>

    <div class="container" style="max-width: 1500px; margin: 0 auto; padding: 20px;">
    <button id="backToList" style="display:none; margin-bottom: 20px; border:none; background:none; cursor:pointer; font-family:'Kanit'; color:#4a5d4d;">
        ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>

    <h2 id="view-title" style="text-align: center; margin-bottom: 30px;">‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£</h2>
    
    <div id="main-content-display" class="cafe-grid">
        </div>

        <div class="floating-auth">
        <a href="../login/index.html" id="mainAuthBtn" class="btn-open-login" style="text-decoration: none;">
            <span>üë§</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </a>
    
        <div id="userAvatar" class="user-profile-float" onclick="location.href='user/index.html'">
        <img src="../imagas/coffee-beans.png" alt="Avatar">
        </div>
    </div>




</div>
    <a href="#" class="floating-btn" id="reviewBtn">
        <span class="icon">‚úèÔ∏è</span>
        <span class="text">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
    </a>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à</h2>
            <p>‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏î‡∏µ‡πÜ ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏°‡∏≤</p>
            
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</label>
                <select id="newCafeName" class="form-select" style="width: 100%; padding: 10px; border-radius: 8px; font-family: 'Kanit';">
                    <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ---</option>
                    <option value="14:25 Hours.">14:25 Hours.</option>
                    <option value="Black Ground Cafe & Dining">Black Ground Cafe & Dining</option>
                    <option value="Chim Niyom Cafe">Chim Niyom Cafe</option>
                    <option value="Faamsuk cafe">Faamsuk cafe</option>
                    <option value="For you coffee Lake view resort">For you coffee Lake view resort</option>
                    <option value="Intense coffee house.">Intense coffee house.</option>
                    <option value="Lark Cafe">Lark Cafe</option>
                    <option value="Makesense">Makesense</option>
                    <option value="Siam2C">Siam2C</option>
                    <option value="Kanvela Art Space">Kanvela Art Space</option>
                    <option value="Bali ‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡πÄ‡∏ï‡πà‡∏≤">Bali ‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡πÄ‡∏ï‡πà‡∏≤</option>
                    <option value="Chim Hong Cafe">Chim Hong Cafe</option>
                </select>
            </div>

            <div class="form-group" style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <label style="font-weight: 600; display: block; margin-bottom: 10px;">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô (1-5)</label>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label style="font-size: 0.85rem;">‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®</label>
            <input type="number" id="ratingAtmosphere" min="1" max="5" step="0.1" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <div>
            <label style="font-size: 0.85rem;">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
            <input type="number" id="ratingService" min="1" max="5" step="0.1" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <div>
            <label style="font-size: 0.85rem;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</label>
            <input type="number" id="ratingFood" min="1" max="5" step="0.1" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <div>
            <label style="font-size: 0.85rem;">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <input type="number" id="ratingPrice" min="1" max="5" step="0.1" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <div style="grid-column: span 2;">
            <label style="font-size: 0.85rem;">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
            <input type="number" id="ratingTravel" min="1" max="5" step="0.1" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
    </div>
</div>

            <div class="form-group">
                <label>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                <textarea id="newReviewText" placeholder="‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏£‡πà‡∏≠‡∏¢ ‡∏°‡∏∏‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ß‡∏¢..." style="width: 100%; height: 100px; padding: 10px; border-radius: 8px;"></textarea>
            </div>


            <div class="form-group">
    <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå)</label>
    <input type="file" id="cafeImageFile" accept="image/*" class="form-select">
</div>

            <button id="submitReview" class="btn-submit" style="width: 100%; padding: 12px; margin-top: 10px;">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏•‡∏¢</button>
        </div>
    </div>

    
<footer class="main-footer">
    <div class="footer-container">
        <div class="footer-content">
            <div class="footer-brand-section">
                <div class="footer-logo">‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£</div>
                <p class="footer-description">‡∏Ñ‡∏≠‡∏°‡∏°‡∏π‡∏ô‡∏¥‡∏ï‡∏µ‡πâ‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡πÉ‡∏ô‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£ ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</p>
                <p class="contact-invitation">‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô? <a href="contact/index.html">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</a></p>
                
            </div>

            <div class="footer-links-grid">
                <div class="footer-column">
                    <h4>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</h4>
                    <ul>
                        <li><a href="../index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                        <li><a href="../allcafe/index.html">‡∏£‡∏ß‡∏°‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</h4>
                    <ul>
                        <li><a href="../map/index.html">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏£‡∏¥‡∏õ</a></li>
                        <li><a href="#">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></li>
                        <li><a href="../login/index.html">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                    <ul>
                        <li><a href="../contact/index.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDt4kR8SacD2LPwmyFpcZ4FNHJpCT-pOwc",
        authDomain: "phichit-cafe.firebaseapp.com",
        projectId: "phichit-cafe",
        storageBucket: "phichit-cafe.firebasestorage.app",
        messagingSenderId: "825175930096",
        appId: "1:825175930096:web:32336ea0ebc1cdf3c33e35",
        measurementId: "G-SNG4GZ50C0" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const cafeList = [
        { name: "14:25 Hours.", img: "../imagas/1425/1425cafe1.jpg"  },
        { name: "Black Ground Cafe & Dining", img: "../imagas/Black Ground Cafe & Dining/Black1.webp" },
        { name: "Chim Niyom Cafe", img: "../imagas/chim/chimcafe1.jpg" },
        { name: "Faamsuk cafe", img: "../imagas/FAAMSUK/FAA1.webp" },
        { name: "For you coffee Lake view resort", img: "../imagas/foryoucoffee/foryou2.webp" },
        { name: "Intense coffee house.", img: "../imagas/Intensecoffeehouse/Intense1.webp" },
        { name: "Lark Cafe", img: "../imagas/LarkCafe/Lark1.webp" },
        { name: "Makesense", img: "../imagas/Make‚ÄãSense/Makesense1.webp" },
        { name: "Siam2C", img: "../imagas/SIAM2C/Siam2C2.webp" },
        { name: "Kanvela Art Space", img: "../imagas/‡∏Å‡∏≤‡∏•‡πÄ‡∏ß‡∏¨‡∏≤/K1.webp" },
        { name: "Bali ‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡πÄ‡∏ï‡πà‡∏≤", img: "../imagas/‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡πÄ‡∏ï‡πà‡∏≤/billcafe1.jpg" },
        { name: "Chim Hong Cafe", img: "../imagas/‡∏ä‡∏¥‡∏°‡∏Æ‡∏á/‡∏ä‡∏¥‡∏°‡∏Æ‡∏á1.webp" }
    ];

    const cafeFiles = {
    "14:25 Hours.": "cafe001",
    "Black Ground Cafe & Dining": "cafe002",
    "Chim Niyom Cafe": "cafe003",
    "Faamsuk cafe": "cafe004",
    "For you coffee Lake view resort": "cafe005",
    "Intense coffee house.": "cafe006",
    "Lark Cafe": "cafe007",
    "Makesense": "cafe008",
    "Siam2C": "cafe009",
    "Kanvela Art Space": "cafe010",
    "Bali ‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡πÄ‡∏ï‡πà‡∏≤": "cafe011",
    "Chim Hong Cafe": "cafe012"
};

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 1: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ---
window.renderCafeList = async function() {
    const backBtn = document.getElementById("backToList");
    const viewTitle = document.getElementById("view-title");
    const mainDisplay = document.getElementById("main-content-display");

    if (backBtn) backBtn.style.display = "none";
    viewTitle.innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô";
    mainDisplay.innerHTML = "<p style='text-align:center; grid-column:1/-1;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...</p>";

    try {
        const q = query(collection(db, "cafes"));
        const snapshot = await getDocs(q);
        const allReviews = [];
        snapshot.forEach(doc => allReviews.push(doc.data()));

        let html = "";
        cafeList.forEach(cafe => {
            const storeReviews = allReviews.filter(r => r.name === cafe.name);
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î ---
            let avgRating = 0;
            let avgDetail = { atmosphere: 0, service: 0, food: 0, price: 0, travel: 0 };

            if (storeReviews.length > 0) {
                const totalReviews = storeReviews.length;
                let sums = { atmosphere: 0, service: 0, food: 0, price: 0, travel: 0, total: 0 };

                storeReviews.forEach(r => {
                    sums.total += parseFloat(r.rating || 0);
                    sums.atmosphere += parseFloat(r.detailRating?.atmosphere || 0);
                    sums.service += parseFloat(r.detailRating?.service || 0);
                    sums.food += parseFloat(r.detailRating?.food || 0);
                    sums.price += parseFloat(r.detailRating?.price || 0);
                    sums.travel += parseFloat(r.detailRating?.travel || 0);
                });

                avgRating = (sums.total / totalReviews).toFixed(1);
                avgDetail = {
                    atmosphere: (sums.atmosphere / totalReviews).toFixed(1),
                    service: (sums.service / totalReviews).toFixed(1),
                    food: (sums.food / totalReviews).toFixed(1),
                    price: (sums.price / totalReviews).toFixed(1),
                    travel: (sums.travel / totalReviews).toFixed(1)
                };
            }

            html += `
                <div class="cafe-card-item" onclick="viewStoreReviews('${cafe.name}')" 
                     style="background:white; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); cursor:pointer; overflow:hidden; transition:0.3s; border:1px solid #eee; position:relative;">
                    
                    <div style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:4px 10px; border-radius:12px; font-weight:bold; color:#4a5d4d; z-index:10; font-size:0.9rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        ${avgRating > 0 ? '‚≠ê ' + avgRating : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß'}
                    </div>

                    <div style="width:100%; height:160px; overflow:hidden; background:#f5f5f5;">
                        <img src="${cafe.img}" alt="${cafe.name}" 
                             style="width:100%; height:100%; object-fit:cover;"
                             onerror="this.src='https://via.placeholder.com/400x250?text=No+Image'">
                    </div>

                    <div style="padding:15px;">
                        <h3 style="margin:0 0 10px 0; color:#4a5d4d; font-size:1.1rem; font-family:'Kanit'; text-align:center;">${cafe.name}</h3>
                        
                        <div class="rating-bar-container" style="font-size: 0.75rem; border-top: 1px solid #f0f0f0; padding-top: 10px;">
                            <div class="rating-item" style="margin-bottom: 4px;">
                                <span style="width: 50px;">‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®</span>
                                <div class="bar-bg" style="flex:1; height:6px;"><div class="bar-fill" style="width: ${avgDetail.atmosphere * 20}%; height:100%;"></div></div>
                                <span class="num" style="width: 20px; text-align:right;">${avgDetail.atmosphere}</span>
                            </div>
                            <div class="rating-item" style="margin-bottom: 4px;">
                                <span style="width: 50px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                                <div class="bar-bg" style="flex:1; height:6px;"><div class="bar-fill" style="width: ${avgDetail.food * 20}%; height:100%;"></div></div>
                                <span class="num" style="width: 20px; text-align:right;">${avgDetail.food}</span>
                            </div>
                        </div>

                        <p style="font-size:0.8rem; color:#888; margin-top:10px; font-family:'Kanit'; text-align:center;">
                            ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${storeReviews.length} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                        </p>
                    </div>
                </div>`;
        });
        mainDisplay.innerHTML = html;
        mainDisplay.style.display = "grid";
        mainDisplay.style.gridTemplateColumns = "repeat(auto-fill, minmax(300px, 1fr))";
        mainDisplay.style.gap = "20px";
    } catch (error) {
        console.error("Error calculating ratings:", error);
        mainDisplay.innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
    }
};

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 2: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 2: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏î‡∏á) ---
window.viewStoreReviews = async function(cafeName) {
    const backBtn = document.getElementById("backToList");
    const viewTitle = document.getElementById("view-title");
    const mainDisplay = document.getElementById("main-content-display");

    backBtn.style.display = "block";
    viewTitle.innerText = "‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á " + cafeName;
    mainDisplay.innerHTML = "<p style='text-align:center; grid-column:1/-1; font-family:Kanit;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...</p>";

    try {
        const q = query(collection(db, "cafes"), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(q);
        let reviewHtml = "";
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.name === cafeName) {
                count++;
                const fileName = cafeFiles[data.name.trim()] || "index";

                // ‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ Backtick ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô String
                reviewHtml += `
                <div class="review-card">
                    <div style="position:absolute; top:15px; right:15px; display:flex; flex-direction:column; align-items:flex-end; gap:5px; z-index:10;">
                        <button onclick="window.location.href='../cafe/${fileName}.html'" 
                                style="background:rgba(74, 93, 77, 0.9); color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-family:'Kanit'; font-size:0.8rem;">
                            ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô üè†
                        </button>
                        <div style="background:rgba(255,255,255,0.8); padding:2px 10px; border-radius:10px; color:#f1c40f; font-weight:bold; font-size:0.9rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            ‚≠ê ${data.rating}
                        </div>
                    </div>

                    <img src="${data.imageURL || 'https://via.placeholder.com/400x250'}" style="width:100%; height:250px; object-fit:cover;">

                    <div style="padding: 15px 20px; background: #fff; border-bottom: 1px dashed #eee; font-family:'Kanit';">
                        <div class="rating-bar-container">
                            <div class="rating-item">
                                <span>‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®</span>
                                <div class="bar-bg"><div class="bar-fill" style="width: ${(data.detailRating?.atmosphere || 0) * 20}%"></div></div>
                                <span class="num">${data.detailRating?.atmosphere || '-'}</span>
                            </div>
                            <div class="rating-item">
                                <span>‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                                <div class="bar-bg"><div class="bar-fill" style="width: ${(data.detailRating?.service || 0) * 20}%"></div></div>
                                <span class="num">${data.detailRating?.service || '-'}</span>
                            </div>
                            <div class="rating-item">
                                <span>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                                <div class="bar-bg"><div class="bar-fill" style="width: ${(data.detailRating?.food || 0) * 20}%"></div></div>
                                <span class="num">${data.detailRating?.food || '-'}</span>
                            </div>
                            <div class="rating-item">
                                <span>‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                                <div class="bar-bg"><div class="bar-fill" style="width: ${(data.detailRating?.price || 0) * 20}%"></div></div>
                                <span class="num">${data.detailRating?.price || '-'}</span>
                            </div>
                            <div class="rating-item">
                                <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</span>
                                <div class="bar-bg"><div class="bar-fill" style="width: ${(data.detailRating?.travel || 0) * 20}%"></div></div>
                                <span class="num">${data.detailRating?.travel || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div style="padding:20px;">
                        <p style="font-family:'Kanit'; color:#555; line-height:1.6; margin-top:5px;">${data.reviewText}</p>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <img src="${data.ReviewerPhoto || '../imagas/coffee-beans.png'}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                            <span style="font-size:0.85rem; color:#777; font-family:'Kanit';">‡πÇ‡∏î‡∏¢ ${data.ReviewerName}</span>
                        </div>
                    </div>
                </div>`;
            }
        });

        if (count === 0) {
            mainDisplay.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; font-family:Kanit;">
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>
            </div>`;
        } else {
            mainDisplay.innerHTML = reviewHtml;
            mainDisplay.style.gridTemplateColumns = "repeat(auto-fill, minmax(300px, 1fr))";
        }
        document.getElementById("newCafeName").value = cafeName;
        window.scrollTo(0,0);
    } catch (error) { 
        console.error("View Reviews Error:", error); 
        mainDisplay.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>";
    }
};

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
    document.addEventListener('DOMContentLoaded', () => {
        window.renderCafeList(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal
        const modal = document.getElementById("reviewModal");
        const openBtn = document.getElementById("reviewBtn");
        const closeBtn = document.querySelector(".close-button");
        if (openBtn) openBtn.onclick = (e) => { e.preventDefault(); modal.style.display = "flex"; };
        if (closeBtn) closeBtn.onclick = () => modal.style.display = "none";
        
        const backBtn = document.getElementById("backToList");
        if (backBtn) backBtn.onclick = window.renderCafeList;
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User ‡πÉ‡∏ô <script type="module">
onAuthStateChanged(auth, async (user) => {
    const authBtn = document.getElementById('mainAuthBtn');
    const avatarDiv = document.getElementById('userAvatar');
    
    if (user) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Login, ‡πÅ‡∏™‡∏î‡∏á Avatar
        if (authBtn) authBtn.style.setProperty('display', 'none', 'important');
        if (avatarDiv) {
            avatarDiv.style.setProperty('display', 'flex', 'important');
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().photo) {
                avatarDiv.querySelector('img').src = userDoc.data().photo;
            }
        }
    } else {
        // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° Login ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô Avatar ***
        if (authBtn) authBtn.style.setProperty('display', 'flex', 'important');
        if (avatarDiv) avatarDiv.style.setProperty('display', 'none', 'important');
    }
});

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "my_cafe_preset");
        const res = await fetch(`https://api.cloudinary.com/v1_1/dkk0c4ls0/image/upload`, { method: "POST", body: formData });
        const data = await res.json();
        return data.secure_url;
    }

    document.getElementById("submitReview").onclick = async () => {
        const user = auth.currentUser;
        if (!user) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }

        const name = document.getElementById("newCafeName").value;
        const text = document.getElementById("newReviewText").value;
        const rAtmosphere = parseFloat(document.getElementById("ratingAtmosphere").value);
const rService = parseFloat(document.getElementById("ratingService").value);
const rFood = parseFloat(document.getElementById("ratingFood").value);
const rPrice = parseFloat(document.getElementById("ratingPrice").value);
const rTravel = parseFloat(document.getElementById("ratingTravel").value);
        const file = document.getElementById("cafeImageFile").files[0];

        const averageOfThisReview = ((rAtmosphere + rService + rFood + rPrice + rTravel) / 5).toFixed(1);

        if (name && text && file) {
            try {
                const btn = document.getElementById("submitReview");
                btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
                
                const url = await uploadToCloudinary(file);
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data() || {};

                await addDoc(collection(db, "cafes"), {
            name, 
            reviewText: text, 
            imageURL: url, 
            rating: averageOfThisReview, // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà Card
            detailRating: {              // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ó‡∏≥‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                atmosphere: rAtmosphere,
                service: rService,
                food: rFood,
                price: rPrice,
                travel: rTravel
            },
            ReviewerName: userData.name || userData.username || "‡∏ô‡∏±‡∏Å‡∏£‡∏µ‡∏ß‡∏¥‡∏ß",
            ReviewerPhoto: userData.photo || "../imagas/coffee-beans.png",
            timestamp: new Date(), 
            userId: user.uid
        });

                alert("‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                location.reload();
            } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        } else { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞‡∏à‡πä‡∏∞"); }
    };

    

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ---
const searchButton = document.getElementById('searchButton');

function performSearch() {
    const keyword = searchInput.value.trim();
    if (keyword) {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡πÉ‡∏ô cafeList ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const found = cafeList.find(c => c.name.toLowerCase() === keyword.toLowerCase());
        
        if (found) {
            window.viewStoreReviews(found.name);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠)
            const partialMatch = cafeList.find(c => c.name.toLowerCase().includes(keyword.toLowerCase()));
            if (partialMatch) {
                window.viewStoreReviews(partialMatch.name);
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞");
            }
        }
    }
}

if (searchButton) searchButton.onclick = performSearch;
if (searchInput) {
    searchInput.onkeypress = (e) => { if (e.key === 'Enter') performSearch(); };
}
    
</script>