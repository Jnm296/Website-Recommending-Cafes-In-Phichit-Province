<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมัครสมาชิก - ค้นพบเสน่ห์คาเฟ่ในพิจิตร</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>

    <div class="register-card">
        <h2>สร้างบัญชีใหม่</h2>
        <p>เริ่มต้นบันทึกคาเฟ่ที่คุณประทับใจ</p>
        <form id="registerForm">
            
    <div class="input-group">
        <input type="text" id="regName" placeholder="ชื่อ-นามสกุล" required>
    </div>

    <div class="input-group">
        <input type="email" id="regEmail" placeholder="อีเมลของคุณ" required>
    </div>

    <div class="input-group">
        <input type="password" id="regPassword" placeholder="ตั้งรหัสผ่าน" required>
    </div>

    <div class="input-group">
        <input type="password" id="confirmPassword" placeholder="ยืนยันรหัสผ่าน" required>
    </div>

    <button type="submit" id="btnSubmit" class="btn-register">สมัครสมาชิก</button>

    <div class="login-link" style="margin-top: 20px; text-align: center;">
        มีบัญชีอยู่แล้วใช่ไหม? <a href=".../index.html">เข้าสู่ระบบเลย</a>
    </div>
</form>
        

        
    </div>

    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
        apiKey: "AIzaSyDt4kR8SacD2LPwmyFpcZ4FNHJpCT-pOwc",
        authDomain: "phichit-cafe.firebaseapp.com",
        databaseURL: "https://phichit-cafe-default-rtdb.firebaseio.com",
        projectId: "phichit-cafe",
        storageBucket: "phichit-cafe.firebasestorage.app",
        messagingSenderId: "825175930096",
        appId: "1:825175930096:web:32336ea0ebc1cdf3c33e35",
        measurementId: "G-SNG4GZ50C0" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

  // ฟังก์ชันดึงข้อมูลมาโชว์
  async function getCafes() {
    const querySnapshot = await getDocs(collection(db, "cafes"));
  }
  getCafes();

        function openLogin() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function handleLogin(e) {
            e.preventDefault();
            // จำลองการล็อกอินสำเร็จ
            closeLogin();
            document.getElementById('mainAuthBtn').style.display = 'none';
            document.getElementById('userAvatar').style.display = 'block';
            alert('ยินดีต้อนรับ! ล็อกอินสำเร็จแล้วค่ะ');
        }

        // คลิกพื้นที่ว่างข้างนอก Pop-up เพื่อปิด
        window.onclick = function(event) {
            if (event.target == document.getElementById('loginModal')) {
                closeLogin();
            }
        }

        window.onload = function () {
    google.accounts.id.initialize({
        // ใส่ Client ID ของคุณที่ได้จาก Google Cloud
        client_id: "33280567312-hrdbjnk3g9guqsfe21coqn0mfpv3n6np.apps.googleusercontent.com",
        callback: handleGoogleResponse
    });
    
    // สร้างปุ่มล็อกอินใน div ที่เราเตรียมไว้
    google.accounts.id.renderButton(
        document.getElementById("googleBtn"),
        { theme: "outline", size: "large", width: "240" }
    );
}

// เพิ่ม async เข้าไปข้างหน้าเพื่อให้ใช้ await บันทึกข้อมูลได้
async function handleGoogleResponse(response) {
    // 1. ถอดรหัสข้อมูลผู้ใช้จาก Google
    const responsePayload = decodeJwtResponse(response.credential);

localStorage.setItem('userProfile', JSON.stringify({
        name: responsePayload.name,
        email: responsePayload.email,
        picture: responsePayload.picture
    }));

    // 2. บันทึกลง Firestore (ใช้ db และ setDoc ที่เรา import มา)
    try {
        await setDoc(doc(db, "users", responsePayload.sub), {
            name: responsePayload.name,
            email: responsePayload.email,
            photo: responsePayload.picture,
            lastLogin: new Date()
        }, { merge: true });
        console.log("บันทึกข้อมูลลง Firestore สำเร็จ!");
    } catch (e) {
        console.error("เกิดข้อผิดพลาดในการบันทึกข้อมูล: ", e);
    }

    // 3. ส่วนการแสดงผลบนหน้าเว็บเหมือนเดิม
    closeLogin();
    document.getElementById('mainAuthBtn').style.display = 'none';
    const userAvatar = document.getElementById('userAvatar');
    userAvatar.style.display = 'block';
    userAvatar.querySelector('img').src = responsePayload.picture;

    alert('ยินดีต้อนรับคุณ ' + responsePayload.name + ' เข้าสู่เว็บไซตฺแนะนำคาเฟ่ในพิจิตรค่ะ!');
}

        
// ฟังก์ชันสำหรับแกะข้อมูล Token (ใช้แบบง่ายๆ)
function decodeJwtResponse(token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

        
    
        window.handleGoogleResponse = handleGoogleResponse;
window.openLogin = openLogin;
window.closeLogin = closeLogin;
window.handleLogin = handleLogin;
        </script>
    </body>
</html>
